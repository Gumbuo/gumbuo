name: Discord Deployment Notification

on:
  push:
    branches: [master]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Get commit info
          COMMIT_MSG=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Create JSON payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg title "üöÄ Gumbuo Deployed to Production" \
            --arg description "New updates are live on gumbuo.io!" \
            --arg commit "$COMMIT_MSG" \
            --arg author "$AUTHOR" \
            --arg hash "$COMMIT_HASH" \
            --arg footer "gumbuo.io | ${{ github.ref_name }}" \
            --arg timestamp "$TIMESTAMP" \
            '{
              embeds: [{
                title: $title,
                description: $description,
                color: 852223,
                fields: [
                  {
                    name: "üìù Commit",
                    value: $commit,
                    inline: false
                  },
                  {
                    name: "üë§ Author",
                    value: $author,
                    inline: true
                  },
                  {
                    name: "üîó Hash",
                    value: ("[`" + $hash + "`](https://github.com/Gumbuo/gumbuo/commit/" + $hash + ")"),
                    inline: true
                  }
                ],
                footer: {
                  text: $footer
                },
                timestamp: $timestamp
              }]
            }')

          # Send to Discord
          curl -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            $DISCORD_WEBHOOK
