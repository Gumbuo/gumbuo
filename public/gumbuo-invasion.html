<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gumbuo Invasion - Arcade Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #00ff00;
        }

        #gameContainer {
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        canvas {
            border: 3px solid #00ff00;
            background: #000;
            display: block;
            margin: 20px auto;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }

        h1 {
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        #score, #lives, #gameOver, #instructions {
            font-size: 1.2em;
            margin: 10px;
            text-shadow: 0 0 5px #00ff00;
        }

        #claimableAP {
            font-size: 1.5em;
            margin: 15px;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            font-weight: bold;
        }

        #startBtn, #restartBtn, #claimBtn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        #claimBtn {
            background: #00ffff;
            color: #000;
        }

        #claimBtn:hover {
            background: #00cccc;
            transform: scale(1.05);
            box-shadow: 0 0 20px #00ffff;
        }

        #claimBtn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }

        #startBtn:hover, #restartBtn:hover {
            background: #00cc00;
            transform: scale(1.05);
            box-shadow: 0 0 20px #00ff00;
        }

        .hidden {
            display: none;
        }

        #instructions {
            font-size: 1em;
            color: #88ff88;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>ðŸš€ GUMBUO INVASION ðŸš€</h1>
        <div id="score">Score: 0</div>
        <div id="lives">Lives: 3</div>
        <div id="claimableAP">ðŸ‘½ Claimable AP: 0 | Enemies Killed: 0</div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="gameOver" class="hidden">
            <h2>GAME OVER!</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Enemies Killed: <span id="finalKills">0</span></p>
            <p>Claimable AP: <span id="finalClaimable">0</span></p>
            <button id="restartBtn">Play Again</button>
        </div>
        <button id="startBtn">Start Game</button>
        <button id="claimBtn" class="hidden">ðŸ’° CLAIM ALIEN POINTS</button>
        <div id="instructions">
            ðŸŽ® Use ARROW KEYS or WASD to fly around | LEFT CLICK or SPACE to shoot | Destroy the Gumbuo aliens!
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const claimBtn = document.getElementById('claimBtn');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const claimableAPDisplay = document.getElementById('claimableAP');
        const gameOverDiv = document.getElementById('gameOver');
        const finalScoreSpan = document.getElementById('finalScore');
        const finalKillsSpan = document.getElementById('finalKills');
        const finalClaimableSpan = document.getElementById('finalClaimable');

        let gameRunning = false;
        let score = 0;
        let lives = 3;
        let animationId;
        let imagesLoaded = false;
        let enemiesKilled = 0; // Track total enemies killed for alien points

        // Alien images
        const alienImages = {};
        const alienImageFiles = ['nyx.png', 'zorb.png', 'baob.png', 'apelian.jpg', 'j3d1.jpg', 'zit.png'];
        let loadedImageCount = 0;

        // Player image
        let playerImage = null;
        let playerImageLoaded = false;

        // Preload alien images
        function loadAlienImages() {
            alienImageFiles.forEach(filename => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                
                img.onload = () => {
                    console.log(`âœ“ Loaded: ${filename}`);
                    loadedImageCount++;
                    if (loadedImageCount === alienImageFiles.length) {
                        imagesLoaded = true;
                        startBtn.disabled = false;
                        startBtn.textContent = 'Start Game';
                    }
                };
                img.onerror = (e) => {
                    console.error(`âœ— Failed to load ${filename} from /${filename}`);
                    loadedImageCount++;
                    if (loadedImageCount === alienImageFiles.length) {
                        imagesLoaded = true;
                        startBtn.disabled = false;
                        startBtn.textContent = 'Start Game (Some images missing)';
                    }
                };
                
                img.src = `/${filename}`;
                alienImages[filename] = img;
            });
        }

        // Stars for scrolling background
        let stars = [];
        function createStars() {
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    speed: Math.random() * 2 + 1
                });
            }
        }

        // Draw and update stars
        function drawStars() {
            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                ctx.fillRect(star.x, star.y, star.size, star.size);
                
                // Move stars down to create scrolling effect
                star.y += star.speed;
                
                // Reset star to top when it goes off bottom
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });
        }

        // Player spaceship
        const player = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 100,
            width: 50,
            height: 60,
            speed: 6,
            moveLeft: false,
            moveRight: false,
            moveUp: false,
            moveDown: false
        };

        // Arrays for game objects
        let bullets = [];
        let aliens = [];
        let alienBullets = [];
        let explosions = [];

        // Game settings
        const bulletSpeed = 8;
        const alienBulletSpeed = 4;
        let alienSpawnRate = 0.02;
        let frameCount = 0;

        // Preload player image
        function loadPlayerImage() {
            playerImage = new Image();
            playerImage.onload = () => {
                console.log('âœ“ Loaded: spacepack-5-original.png');
                playerImageLoaded = true;
            };
            playerImage.onerror = () => {
                console.error('âœ— Failed to load spacepack-5-original.png');
                playerImageLoaded = false;
            };
            playerImage.src = '/spacepack-5-original.png';
        }

        // Load images on page load
        startBtn.disabled = true;
        startBtn.textContent = 'Loading...';
        loadAlienImages();
        loadPlayerImage();
        createStars();

        // Draw player character
        function drawPlayer() {
            if (playerImageLoaded && playerImage) {
                // Extract top spaceship from Spacepack 5.png
                // The top ship is in the upper portion of the image
                const shipSrcX = 0;
                const shipSrcY = 0;
                const shipSrcWidth = playerImage.width;
                const shipSrcHeight = playerImage.height / 3; // Top third contains the ship

                // Save context and rotate for vertical orientation
                ctx.save();
                ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
                ctx.rotate(-Math.PI / 2); // Rotate 90 degrees counter-clockwise to point up

                // Draw the ship centered and rotated
                ctx.drawImage(
                    playerImage,
                    shipSrcX, shipSrcY, shipSrcWidth, shipSrcHeight,
                    -player.height / 2, -player.width / 2, player.height, player.width
                );

                ctx.restore();
            } else {
                // Fallback: triangle spaceship
                ctx.fillStyle = '#00ffff';
                ctx.beginPath();
                ctx.moveTo(player.x + player.width / 2, player.y);
                ctx.lineTo(player.x, player.y + player.height);
                ctx.lineTo(player.x + player.width, player.y + player.height);
                ctx.closePath();
                ctx.fill();
            }
        }

        // Spawn alien enemies
        function spawnAlien() {
            if (Math.random() < alienSpawnRate) {
                const alienType = alienImageFiles[Math.floor(Math.random() * alienImageFiles.length)];
                const alienWidth = 50;
                const alienHeight = 50;
                
                aliens.push({
                    x: Math.random() * (canvas.width - alienWidth),
                    y: -alienHeight,
                    width: alienWidth,
                    height: alienHeight,
                    speed: Math.random() * 2 + 1,
                    alive: true,
                    image: alienImages[alienType],
                    shootTimer: Math.random() * 100
                });
            }
        }

        // Draw alien
        function drawAlien(alien) {
            if (!alien.alive) return;

            if (alien.image && alien.image.complete && alien.image.naturalWidth > 0) {
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                const imgAspect = alien.image.naturalWidth / alien.image.naturalHeight;
                const alienAspect = alien.width / alien.height;
                
                let drawWidth = alien.width;
                let drawHeight = alien.height;
                let offsetX = 0;
                let offsetY = 0;
                
                if (imgAspect > alienAspect) {
                    drawHeight = alien.width / imgAspect;
                    offsetY = (alien.height - drawHeight) / 2;
                } else {
                    drawWidth = alien.height * imgAspect;
                    offsetX = (alien.width - drawWidth) / 2;
                }
                
                ctx.drawImage(alien.image,
                    alien.x + offsetX,
                    alien.y + offsetY,
                    drawWidth,
                    drawHeight);

                // Red border around alien
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.strokeRect(alien.x, alien.y, alien.width, alien.height);
            } else {
                // Fallback alien
                ctx.fillStyle = '#ff00ff';
                ctx.fillRect(alien.x, alien.y, alien.width, alien.height);
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(alien.x + 10, alien.y + 10, 8, 8);
                ctx.fillRect(alien.x + 32, alien.y + 10, 8, 8);
            }
        }

        // Draw bullet
        function drawBullet(bullet) {
            if (bullet.fromPlayer && playerImageLoaded && playerImage) {
                // Extract bullet sprite from middle section of Spacepack 5.png
                const bulletSrcX = 0;
                const bulletSrcY = playerImage.height / 3; // Middle third contains the bullet
                const bulletSrcWidth = playerImage.width;
                const bulletSrcHeight = playerImage.height / 3;

                ctx.save();
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#ff6600';
                ctx.drawImage(
                    playerImage,
                    bulletSrcX, bulletSrcY, bulletSrcWidth, bulletSrcHeight,
                    bullet.x - bullet.width, bullet.y - bullet.height / 2,
                    bullet.width * 3, bullet.height * 2
                );
                ctx.restore();
            } else {
                // Alien bullets remain as red rectangles
                ctx.fillStyle = '#ff0000';
                ctx.shadowBlur = 5;
                ctx.shadowColor = '#ff0000';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                ctx.shadowBlur = 0;
            }
        }

        // Create explosion effect
        function createExplosion(x, y) {
            for (let i = 0; i < 15; i++) {
                explosions.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6,
                    life: 30,
                    size: Math.random() * 3 + 2
                });
            }
        }

        // Draw explosions
        function drawExplosions() {
            explosions.forEach((particle, index) => {
                ctx.fillStyle = `rgba(255, ${150 - particle.life * 3}, 0, ${particle.life / 30})`;
                ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
                
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;
                
                if (particle.life <= 0) {
                    explosions.splice(index, 1);
                }
            });
        }

        // Update player position
        function updatePlayer() {
            if (player.moveLeft && player.x > 0) {
                player.x -= player.speed;
            }
            if (player.moveRight && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            if (player.moveUp && player.y > 0) {
                player.y -= player.speed;
            }
            if (player.moveDown && player.y < canvas.height - player.height) {
                player.y += player.speed;
            }
        }

        // Update bullets
        function updateBullets() {
            bullets = bullets.filter(bullet => {
                bullet.y -= bulletSpeed;
                return bullet.y > -bullet.height;
            });

            alienBullets = alienBullets.filter(bullet => {
                bullet.y += alienBulletSpeed;
                return bullet.y < canvas.height;
            });
        }

        // Update aliens
        function updateAliens() {
            aliens.forEach((alien, index) => {
                if (!alien.alive) return;

                alien.y += alien.speed;

                // Remove aliens that went off screen
                if (alien.y > canvas.height) {
                    aliens.splice(index, 1);
                    return;
                }

                // Alien shooting
                alien.shootTimer--;
                if (alien.shootTimer <= 0 && Math.random() < 0.02) {
                    alienBullets.push({
                        x: alien.x + alien.width / 2 - 2,
                        y: alien.y + alien.height,
                        width: 4,
                        height: 12,
                        fromPlayer: false
                    });
                    alien.shootTimer = Math.random() * 100 + 50;
                }
            });
        }

        // Check collisions
        function checkCollisions() {
            // Player bullet hits alien
            bullets.forEach((bullet, bIndex) => {
                aliens.forEach((alien, aIndex) => {
                    if (alien.alive &&
                        bullet.x < alien.x + alien.width &&
                        bullet.x + bullet.width > alien.x &&
                        bullet.y < alien.y + alien.height &&
                        bullet.y + bullet.height > alien.y) {
                        alien.alive = false;
                        bullets.splice(bIndex, 1);
                        score += 10;
                        enemiesKilled++;
                        updateScore();
                        createExplosion(alien.x + alien.width / 2, alien.y + alien.height / 2);
                        aliens.splice(aIndex, 1);
                    }
                });
            });

            // Alien bullet hits player
            alienBullets.forEach((bullet, index) => {
                if (bullet.x < player.x + player.width &&
                    bullet.x + bullet.width > player.x &&
                    bullet.y < player.y + player.height &&
                    bullet.y + bullet.height > player.y) {
                    alienBullets.splice(index, 1);
                    lives--;
                    updateLives();
                    createExplosion(player.x + player.width / 2, player.y + player.height / 2);
                    if (lives <= 0) {
                        endGame();
                    }
                }
            });

            // Alien collides with player
            aliens.forEach((alien, index) => {
                if (alien.alive &&
                    alien.x < player.x + player.width &&
                    alien.x + alien.width > player.x &&
                    alien.y < player.y + player.height &&
                    alien.y + alien.height > player.y) {
                    alien.alive = false;
                    aliens.splice(index, 1);
                    lives--;
                    updateLives();
                    createExplosion(alien.x + alien.width / 2, alien.y + alien.height / 2);
                    if (lives <= 0) {
                        endGame();
                    }
                }
            });
        }

        // Update score display
        function updateScore() {
            scoreDisplay.textContent = `Score: ${score}`;
            claimableAPDisplay.textContent = `ðŸ‘½ Claimable AP: ${score} | Enemies Killed: ${enemiesKilled}`;

            // Show claim button if there's claimable AP
            if (score > 0) {
                claimBtn.classList.remove('hidden');
            }

            // Increase difficulty as score goes up
            if (score % 100 === 0 && score > 0) {
                alienSpawnRate = Math.min(alienSpawnRate + 0.005, 0.05);
            }
        }

        // Update lives display
        function updateLives() {
            livesDisplay.textContent = `Lives: ${lives}`;
        }

        // Game loop
        function gameLoop() {
            if (!gameRunning) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            frameCount++;
            
            drawStars();
            spawnAlien();
            updatePlayer();
            updateBullets();
            updateAliens();
            checkCollisions();

            drawPlayer();
            bullets.forEach(drawBullet);
            alienBullets.forEach(drawBullet);
            aliens.forEach(drawAlien);
            drawExplosions();

            animationId = requestAnimationFrame(gameLoop);
        }

        // Start game
        function startGame() {
            gameRunning = true;
            score = 0;
            lives = 3;
            enemiesKilled = 0;
            alienSpawnRate = 0.02;
            bullets = [];
            alienBullets = [];
            aliens = [];
            explosions = [];
            frameCount = 0;

            updateScore();
            updateLives();
            createStars();

            startBtn.classList.add('hidden');
            gameOverDiv.classList.add('hidden');
            claimBtn.classList.add('hidden');

            gameLoop();
        }

        // End game
        function endGame() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            finalScoreSpan.textContent = score;
            finalKillsSpan.textContent = enemiesKilled;
            finalClaimableSpan.textContent = score;
            gameOverDiv.classList.remove('hidden');
        }

        // Claim alien points
        function claimAlienPoints() {
            if (score <= 0) {
                alert('No alien points to claim!');
                return;
            }

            console.log('ðŸŽ® Claiming', score, 'alien points from Gumbuo Invasion');

            // Disable button while claiming
            claimBtn.disabled = true;
            claimBtn.textContent = 'CLAIMING...';

            // Send message to parent window
            if (window.parent) {
                window.parent.postMessage({
                    type: 'INVASION_CLAIM_AP',
                    alienPoints: score,
                    enemiesKilled: enemiesKilled
                }, '*');

                // Wait for response from parent (with timeout)
                let claimed = false;
                const claimTimeout = setTimeout(() => {
                    if (!claimed) {
                        alert('âš ï¸ Claim timed out. Please make sure your wallet is connected and try again.');
                        claimBtn.disabled = false;
                        claimBtn.textContent = 'ðŸ’° CLAIM ALIEN POINTS';
                    }
                }, 10000);

                // Listen for success/failure message from parent
                const messageHandler = (event) => {
                    if (event.data.type === 'INVASION_CLAIM_SUCCESS') {
                        claimed = true;
                        clearTimeout(claimTimeout);

                        // Show success message
                        alert(`ðŸŽ‰ Successfully claimed ${score} Alien Points!\n\nEnemies Killed: ${enemiesKilled}\n\nâœ¨ Your HUD will update in a moment!`);

                        // Reset claimable amount
                        score = 0;
                        enemiesKilled = 0;
                        updateScore();
                        claimBtn.classList.add('hidden');
                        claimBtn.disabled = false;
                        claimBtn.textContent = 'ðŸ’° CLAIM ALIEN POINTS';

                        window.removeEventListener('message', messageHandler);
                    } else if (event.data.type === 'INVASION_CLAIM_FAILED') {
                        claimed = true;
                        clearTimeout(claimTimeout);

                        alert(`âŒ Failed to claim points!\n\n${event.data.error || 'Please make sure your wallet is connected and try again.'}`);

                        claimBtn.disabled = false;
                        claimBtn.textContent = 'ðŸ’° CLAIM ALIEN POINTS';

                        window.removeEventListener('message', messageHandler);
                    }
                };

                window.addEventListener('message', messageHandler);
            } else {
                alert('Error: Could not communicate with parent window. Make sure you are playing through the game portal.');
                claimBtn.disabled = false;
                claimBtn.textContent = 'ðŸ’° CLAIM ALIEN POINTS';
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;

            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                player.moveLeft = true;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                player.moveRight = true;
            }
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                player.moveUp = true;
            }
            if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                player.moveDown = true;
            }
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                bullets.push({
                    x: player.x + player.width / 2 - 2,
                    y: player.y,
                    width: 4,
                    height: 15,
                    fromPlayer: true
                });
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                player.moveLeft = false;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                player.moveRight = false;
            }
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                player.moveUp = false;
            }
            if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                player.moveDown = false;
            }
        });

        // Mouse click to shoot
        canvas.addEventListener('click', (e) => {
            if (!gameRunning) return;

            bullets.push({
                x: player.x + player.width / 2 - 2,
                y: player.y,
                width: 4,
                height: 15,
                fromPlayer: true
            });
        });

        // Button event listeners
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);
        claimBtn.addEventListener('click', claimAlienPoints);
    </script>
</body>
</html>